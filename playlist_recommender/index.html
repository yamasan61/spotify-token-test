<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Playlist Recommender</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;margin:0;padding:2rem 1rem;}
    h1{margin-top:0;text-align:center;}
    #loginBtn{display:inline-block;margin:1rem auto;padding:0.8rem 1.6rem;font-size:1.1rem;border:none;border-radius:6px;background:#1db954;color:#fff;cursor:pointer;}
    #tracks{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-top:2rem;}
    .card{background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:0.8rem;text-align:center;}
    .card img{width:100%;border-radius:6px;}
    .title{font-size:0.9rem;font-weight:bold;margin:0.4rem 0;}
    .artist{font-size:0.8rem;color:#555;}
  </style>
</head>
<body>
  <h1>Spotify おすすめ楽曲</h1>
  <button id="loginBtn">Spotify でログイン</button>
  <div id="tracks"></div>

  <script type="module">
    import { createPKCE } from './pkce.js';

    const clientId    = '89175f465b5d42c9aac789c37cf8d730';
    const redirectUri = 'https://yamasan61.github.io/spotify-token-test/playlist_recommender/callback.html';
    const scope       = 'user-read-private';

    const loginBtn  = document.getElementById('loginBtn');
    const tracksElm = document.getElementById('tracks');

    /* ---------- 共通フェッチ ---------- */
    async function safeFetch(url, token){
      const res = await fetch(url,{headers:{Authorization:'Bearer '+token}});
      let detail='';try{detail=await res.clone().text();}catch(_){}
      if(res.status===401) throw new Error('401: トークン期限切れ\\n'+detail);
      if(res.status===403) throw new Error('403: 認可エラー\\n'+detail);
      if(!res.ok)          throw new Error(res.status+' : '+detail);
      return res.json();
    }

    /* ---------- Spotify ログイン ---------- */
    loginBtn.addEventListener('click', async () => {
      const { verifier, challenge } = await createPKCE();
      sessionStorage.setItem('code_verifier', verifier);

      const p = new URLSearchParams({
        client_id: clientId,
        response_type: 'code',
        redirect_uri: redirectUri,
        scope,
        code_challenge_method: 'S256',
        code_challenge: challenge,
        show_dialog: 'true'
      });
      location.href = 'https://accounts.spotify.com/authorize?' + p.toString();
    });

    /* ---------- ページロード時に曲取得 ---------- */
    const accessToken = sessionStorage.getItem('access_token');
    if (accessToken) {
      loginBtn.style.display = 'none';
      fetchRecommendations(accessToken);
    }

    /* ---------- 曲取得関数 ---------- */
    async function fetchRecommendations(token) {
      tracksElm.textContent = 'Loading…';

      /* まず recommendations を試す */
      const recURL = 'https://api.spotify.com/v1/recommendations?seed_genres=pop&limit=10&market=JP';
      let data;
      try {
        data = await safeFetch(recURL, token);
      } catch(e) {
        if (e.message.startsWith('404')) {
          /* 404 → search にフォールバック（ランダム offset で毎回変える） */
          const offset = Math.floor(Math.random()*1000);
          const searchURL = `https://api.spotify.com/v1/search?q=genre%3Apop&type=track&limit=10&offset=${offset}&market=JP`;
          data = await safeFetch(searchURL, token);
          data = { tracks: data.tracks.items };
        } else {
          tracksElm.textContent = e.message;
          return;
        }
      }

      const list = data.tracks?.items ?? data.tracks ?? [];
      if (!list.length) {
        tracksElm.textContent = '曲が取得できませんでした';
        return;
      }

      tracksElm.innerHTML = '';
      list.forEach(t => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${t.album.images[0]?.url || ''}" alt="${t.name}">
          <p class="title">${t.name}</p>
          <p class="artist">${t.artists.map(a=>a.name).join(', ')}</p>`;
        tracksElm.appendChild(card);
      });
    }
  </script>
</body>
</html>
