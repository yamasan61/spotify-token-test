<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Callback - Spotify PKCE Demo</title>
</head>
<body>
  <h1>Spotify Token Exchange</h1>
  <div id="status">処理中...</div>

  <script type="module">
    const clientId = '89175f465b5d42c9aac789c37cf8d730';
    const redirectUri = 'https://yamasan61.github.io/spotify-token-test/playlist_recommender/callback.html';

    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    const statusElm = document.getElementById('status');

    if (!code) {
      statusElm.textContent = '認可コードが取得できませんでした。';
      console.error('No code in URL');
      throw new Error('No code');
    }

    const verifier = sessionStorage.getItem('code_verifier');
    if (!verifier) {
      statusElm.textContent = 'code_verifier が見つかりません。';
      console.error('No code_verifier');
      throw new Error('No verifier');
    }

    try {
      const body = new URLSearchParams({
        client_id: clientId,
        grant_type: 'authorization_code',
        code,
        redirect_uri: redirectUri,
        code_verifier: verifier
      });

      const res = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }),
        body
      };

      if (!res.ok) {
        const errText = await res.text();
        throw new Error('Token endpoint error: ' + errText);
      }

      const json = await res.json();
      console.log('Token response', json);
      const { access_token, refresh_token, expires_in } = json;

      if (access_token) {
        statusElm.innerHTML = `
          <p style="color:green">Access Token: ${access_token}</p>
          <p>Expires in: ${expires_in} seconds</p>
          ${refresh_token ? `<p>Refresh Token: ${refresh_token}</p>` : ''}
        `;
      } else {
        statusElm.textContent = 'トークンが取得できませんでした。';
      }
    } catch (err) {
      console.error(err);
      statusElm.textContent = 'エラー: ' + err.message;
    }
  </script>
</body>
</html>
