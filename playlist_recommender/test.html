<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Playlist Recommender</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Spotify おすすめ楽曲</h1>

  <div class="wrapper">
    <button id="loginBtn">Spotify でログイン</button>
  </div>

  <div class="selector">
    <label>ジャンル:
      <select id="genreSelect"></select>
    </label>
  </div>

  <div id="tracks"></div>

  <script type="module">
    import { createPKCE } from './pkce.js';

    const clientId    = '89175f465b5d42c9aac789c37cf8d730';
    const redirectUri = 'https://yamasan61.github.io/spotify-token-test/playlist_recommender/callback.html';
    const scope       = 'user-read-private';

    const loginBtn   = document.getElementById('loginBtn');
    const tracksElm  = document.getElementById('tracks');
    const genreSelect= document.getElementById('genreSelect');

    // ジャンル JSON 読込
    try {
      const res = await fetch('genres.json');
      const { genres } = await res.json();
      genres.forEach(({label,value})=>{
        const opt=document.createElement('option');
        opt.value=value;opt.textContent=label;
        genreSelect.appendChild(opt);
      });
    } catch(e){console.error(e);}

    loginBtn.addEventListener('click', async ()=>{
      const { verifier, challenge } = await createPKCE();
      sessionStorage.setItem('code_verifier', verifier);

      const p = new URLSearchParams({
        client_id:clientId,
        response_type:'code',
        redirect_uri:redirectUri,
        scope,
        code_challenge_method:'S256',
        code_challenge:challenge,
        show_dialog:'true'
      });
      location.href='https://accounts.spotify.com/authorize?'+p;
    });

    const token=sessionStorage.getItem('access_token');
    if(token){loginBtn.style.display='none';fetchTracks(token);}
    genreSelect.addEventListener('change',()=>{const t=sessionStorage.getItem('access_token');if(t)fetchTracks(t);});

    async function fetchTracks(token){
      tracksElm.textContent='Loading...';
      const genre=genreSelect.value||'pop';
      const offset=Math.floor(Math.random()*1000);
      const url=`https://api.spotify.com/v1/search?q=genre%3A${encodeURIComponent(genre)}&type=track&limit=10&offset=${offset}&market=JP`;
      try{
        const res=await fetch(url,{headers:{Authorization:'Bearer '+token}});
        if(!res.ok)throw new Error('API '+res.status);
        let {tracks:{items=[]}}=await res.json();
        // シャッフル
        for(let i=items.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[items[i],items[j]]=[items[j],items[i]];}
        tracksElm.innerHTML='';
        items.forEach(t=>{
          const c=document.createElement('div');
          c.className='card';
          c.innerHTML=`<img src="${t.album.images[0]?.url||''}" alt="${t.name}">
            <p class="title">${t.name}</p>
            <p class="artist">${t.artists.map(a=>a.name).join(', ')}</p>`;
          tracksElm.appendChild(c);
        });
      }catch(e){tracksElm.textContent=e.message;}
    }
  </script>
</body>
</html>
